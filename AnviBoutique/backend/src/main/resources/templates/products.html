<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <title th:text="${currentCategory} + ' | Anvi Studio'"></title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Roboto:wght@300;400&display=swap" rel="stylesheet">
    <style>
        :root{
            --brand:#ff7c04;
            --dark:#222;
            --filter-border: #ddd; /* Light border for filter sections */
        }
        /* Fix: Set min-height for full viewport and remove default margin/padding if needed */
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f7f7f7;
            color: #222;
            min-height: 100vh; /* Ensure full viewport coverage */
            display: flex;
            flex-direction: column; /* Allows footer to be pushed to the bottom */
        }
        /* New Style for Offer Bar */
        .offer-bar{
            background: linear-gradient(90deg,#111, #222);
            color:#fff;
            padding:6px 0;
            font-size:0.95rem;
        }
        .offer-bar a{ color:var(--brand); text-decoration:none; font-weight:600; }

        .main-nav{ background:#000; color:#fff; }
        /* *** FIX: Ensure active links are always clearly visible *** */
        .main-nav .nav-link{ color:#fff; }
        .main-nav .nav-link:hover,
        .main-nav .nav-link.active {
            color: var(--brand); /* Active/Hover color */
            font-weight: 700;    /* Make active link bold */
            border-bottom: 2px solid var(--brand); /* Subtle underline for clarity */
            padding-bottom: 4px;
        }
        /* *** END FIX *** */

        .navbar-nav { align-items: center; }
        .product-card{ border-radius:12px; overflow:hidden; border:1px solid #eee; position: relative; cursor: pointer;} /* Added position: relative, cursor: pointer */
        .product-card .card-img-top{ height:350px; object-fit:cover; }
        .btn-brand { background-color: var(--brand); border-color: var(--brand); color: white; }
        .btn-brand:hover { background-color: #cc6300; border-color: #cc6300; }
        .hero-title { font-family: 'Playfair Display', serif; font-weight: 700; color: #000; }

        /* Content wrapper to allow the footer to stick to the bottom */
        .main-content {
            flex-grow: 1; /* This pushes the footer down */
        }

        /* Filter Sidebar Styles */
        .filter-sidebar {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        .filter-group {
            border-bottom: 1px solid var(--filter-border);
            padding-bottom: 15px;
            margin-bottom: 15px;
        }
        .filter-group:last-child {
            border-bottom: none;
            padding-bottom: 0;
            margin-bottom: 0;
        }
        .color-swatch {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            display: inline-block;
            cursor: pointer;
            border: 2px solid transparent;
            margin-right: 10px;
            transition: border-color 0.2s;
        }
        /* Color active state needs adjustment if color filtering is fully implemented */
        .color-swatch-wrapper {
            margin-right: 8px;
        }
        /* FIX: Active state for color swatch when radio button is checked */
        .color-swatch-wrapper input:checked + .color-swatch {
            border-color: var(--dark);
            box-shadow: 0 0 0 3px rgba(255, 124, 4, 0.4);
        }
        .color-label {
            display: flex;
            align-items: center;
            margin-right: 15px;
            margin-bottom: 8px;
            cursor: pointer;
        }
        .color-label span {
            margin-left: 5px;
        }

        /* Price Discount Styles */
        .original-price { text-decoration: line-through; color: #888; font-size: 0.75em; margin-right: 5px; }
        .discount-badge { font-size: 0.7em; margin-left: 5px; }

        /* NEW: Sale/Clearance Status Badge */
        .sale-status-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 10;
            padding: 5px 10px;
            font-size: 0.8rem;
            font-weight: bold;
            border-radius: 4px;
        }
        .sale-badge { background-color: #007bff; color: white; } /* Blue/Regular Sale */
        .clearance-badge { background-color: #dc3545; color: white; } /* Red/Clearance Sale */

        /* New: Make the whole card clickable and remove default link underline */
        .product-card a {
            text-decoration: none;
            color: inherit;
            display: contents; /* Allows nested elements to layout as normal */
        }
        .product-link-wrapper {
            position: absolute;
            inset: 0;
            z-index: 5; /* Above content but below buttons */
        }
        /* Specific Z-index for buttons so they remain clickable */
        .btn-group, .btn-dark {
             position: relative;
             z-index: 10;
        }

        /* Footer styling for consistency */
        footer {
            background-color: var(--dark);
            color: #fff;
        }
    </style>
</head>
<body>

<!-- INCLUDE REUSABLE NAVBAR FRAGMENT -->
<div th:insert="~{navbar.html :: main-navbar(currentPage='shop')}"></div>

<!-- 2. ADDED: Main Content Wrapper -->
<div class="main-content">
    <div class="container my-5">
        <h1 class="hero-title display-5 mb-4" th:text="${currentCategory}">Product Catalog</h1>
        <hr>

        <div class="row g-4 mt-4">

            <!-- Left Column: Filter Sidebar (col-lg-3) -->
            <div class="col-lg-3">
                <div class="filter-sidebar sticky-top" style="top: 20px;">
                    <h5 class="fw-bold mb-3">Filters</h5>

                    <!-- The main filter form wraps all controls -->
                    <form th:action="@{/products}" method="get" id="filterForm">

                        <!-- Hidden fields to preserve state across filter changes -->
                        <input type="hidden" name="category" th:value="${currentCategory == 'All Products' ? '' : category}">
                        <input type="hidden" name="sortBy" th:value="${selectedSortBy}">
                        <input type="hidden" name="keyword" th:value="${currentKeyword}"> <!-- Preserve keyword -->

                        <!-- Filter Group: Price Range (HTML consistency check) -->
                        <div class="filter-group">
                            <h6 class="fw-bold">Filter by Price</h6>
                            <label for="priceRangeMin" class="small">Min Price: ₹ <span id="priceMinDisplay" th:text="${#numbers.formatDecimal(minPriceValue ?: 0, 0, 'COMMA', 0, 'POINT')}">0</span></label>
                            <!-- Min Price Slider -->
                            <input type="range" class="form-range" id="priceRangeMin" min="0" max="100000" step="100"
                                   name="minPrice" th:value="${minPriceValue ?: 0}"
                                   oninput="document.getElementById('priceMinDisplay').textContent = parseInt(this.value).toLocaleString('en-IN');">

                            <label for="priceRangeMax" class="small">Max Price: ₹ <span id="priceMaxDisplay" th:text="${#numbers.formatDecimal(maxPriceValue ?: 100000, 0, 'COMMA', 0, 'POINT')}">100000</span></label>
                            <!-- Max Price Slider -->
                            <input type="range" class="form-range" id="priceRangeMax" min="0" max="100000" step="100"
                                   name="maxPrice" th:value="${maxPriceValue ?: 100000}"
                                   oninput="document.getElementById('priceMaxDisplay').textContent = parseInt(this.value).toLocaleString('en-IN');">

                            <button type="submit" class="btn btn-sm btn-outline-secondary w-100 mt-2">Apply Price Filter</button>
                        </div>

                        <!-- Filter Group: Status / Stock -->
                        <div class="filter-group">
                            <h6 class="fw-bold">Filter by Status</h6>

                            <!-- Status Filter Radio Buttons -->
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="status" id="statusInStock" value="inStock"
                                       th:checked="${selectedStatus == 'inStock'}">
                                <label class="form-check-label" for="statusInStock">In Stock</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="status" id="statusLowStock" value="lowStock"
                                       th:checked="${selectedStatus == 'lowStock'}">
                                <label class="form-check-label" for="statusLowStock">Low Stock (5 or less)</label>
                            </div>
                            <!-- Updated Filter Options for Sale/Clearance -->
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="status" id="statusOnSale" value="onSale"
                                       th:checked="${selectedStatus == 'onSale'}">
                                <label class="form-check-label" for="statusOnSale">On Sale (Any Discount)</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="status" id="statusClearance" value="clearance"
                                       th:checked="${selectedStatus == 'clearance'}">
                                <label class="form-check-label" for="statusClearance">Clearance (50%+ Off)</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="status" id="statusAll" value=""
                                       th:checked="${selectedStatus == null or selectedStatus == ''}">
                                <label class="form-check-label" for="statusAll">All Status</label>
                            </div>

                            <!-- This button submits the form, applying the selected radio status -->
                            <button type="submit" class="btn btn-sm btn-outline-secondary w-100 mt-2">Apply Status Filter</button>
                        </div>

                        <!-- Filter Group: Color Swatches (Using submit on change for quick filtering) -->
                        <div class="filter-group">
                            <h6 class="fw-bold">Colour</h6>
                            <div class="d-flex flex-wrap">
                                <label th:each="colorName : ${filterColors}" class="color-label">
                                    <input type="radio" name="color" th:value="${colorName}" style="display: none;"
                                           th:checked="${selectedColor == colorName}" onchange="this.form.submit()">
                                    <div class="color-swatch-wrapper">
                                        <span class="color-swatch"
                                              th:style="'background-color: ' + ${colorName}"
                                              th:classappend="${selectedColor == colorName} ? 'active'"></span>
                                    </div>
                                    <span>[[${colorName}]]</span>
                                </label>

                                <!-- Option to clear color filter -->
                                <label class="color-label">
                                    <input type="radio" name="color" value="" style="display: none;"
                                           th:checked="${selectedColor == null or selectedColor == ''}" onchange="this.form.submit()">
                                    <div class="color-swatch-wrapper">
                                        <span class="color-swatch" style="background-color: white; border-color: #ddd;"></span>
                                    </div>
                                    <span>All</span>
                                </label>
                            </div>
                        </div>

                    </form>

                    <!-- Sidebar: Product Categories (Links that navigate away, included for context) -->
                    <div class="filter-group">
                        <h6 class="fw-bold">Product Categories</h6>
                        <ul class="list-unstyled small">
                            <!-- Preserve current filters when changing category -->
                            <li th:each="cat : ${allCategories}">
                                <a th:href="@{/products(category=${cat})}" th:text="${cat}"
                                   th:classappend="${category == cat} ? 'fw-bold'"></a> <!-- Using 'category' param for highlighting -->
                            </li>
                            <li><a th:href="@{/products}" class="fw-bold" th:classappend="${category == null or category == ''} ? 'active'">All Products</a></li> <!-- Using 'category' param for highlighting -->
                        </ul>
                    </div>

                </div>
            </div>

            <!-- Right Column: Sorting and Product Grid (col-lg-9) -->
            <div class="col-lg-9">

                <!-- Top Bar: Sorting -->
                <div class="d-flex justify-content-end align-items-center mb-4">
                    <form th:action="@{/products}" method="get" id="sortForm">
                        <!-- Hidden fields to preserve current filter state when sorting -->
                        <input type="hidden" name="category" th:value="${category}">
                        <input type="hidden" name="minPrice" th:value="${minPriceValue}">
                        <input type="hidden" name="maxPrice" th:value="${maxPriceValue}">
                        <input type="hidden" name="status" th:value="${selectedStatus}">
                        <input type="hidden" name="color" th:value="${selectedColor}">
                        <input type="hidden" name="keyword" th:value="${currentKeyword}"> <!-- Preserve search keyword on sort -->

                        <label for="sortBySelect" class="form-label me-2 mb-0 small">Sort By:</label>
                        <select name="sortBy" id="sortBySelect" class="form-select form-select-sm d-inline-block w-auto" onchange="this.form.submit()">
                            <option value="latest" th:selected="${selectedSortBy == 'latest'}">Latest Arrivals</option>
                            <option value="oldest" th:selected="${selectedSortBy == 'oldest'}">Oldest</option>
                            <option value="priceAsc" th:selected="${selectedSortBy == 'priceAsc'}">Price: Low to High</option>
                            <option value="priceDesc" th:selected="${selectedSortBy == 'priceDesc'}">Price: High to Low</option>
                        </select>
                    </form>
                </div>

                <!-- Product Grid -->
                <div th:if="${#lists.isEmpty(products)}" class="alert alert-warning text-center">
                    <p class="lead mb-0">No products found matching the current filters.</p>
                </div>

                <div class="row g-4">
                    <!-- Loop through products provided by ProductController -->
                    <div class="col-sm-6 col-md-4" th:each="p : ${products}">
                        <div class="card product-card shadow-sm h-100">

                            <!-- SALE/CLEARANCE BADGE -->
                            <span th:if="${p.isClearance()}" class="sale-status-badge clearance-badge">CLEARANCE!</span>
                            <span th:unless="${p.isClearance() or p.discountPercent == 0}" class="sale-status-badge sale-badge">SALE</span>

                            <!-- PRODUCT LINK WRAPPER (Now wraps image and details, but excludes action buttons) -->
                            <a th:href="@{'/products/' + ${p.id}}" class="product-link-wrapper">
                                <div style="position: absolute; inset: 0; bottom: 120px;"></div> <!-- Covers image area and title/price area -->
                            </a>

                            <!-- Product Image -->
                            <img th:src="${p.imageUrl != null ? p.imageUrl : 'https://placehold.co/600x600/ccc/333?text=No+Image'}"
                                 onerror="this.onerror=null; this.src='https://placehold.co/600x600/ccc/333?text=Error+Loading';"
                                 class="card-img-top"
                                 alt="Product Image">

                            <div class="card-body d-flex flex-column">
                                <h5 class="card-title" th:text="${p.name}">Product Name</h5>
                                <p class="text-muted small mb-2" th:text="${p.category}"></p>

                                <!-- Price Display Logic (Updated for Discount) -->
                                <p class="card-text fw-bold fs-5 mt-auto">
                                    <span th:if="${p.discountPercent > 0}" class="text-secondary d-block">
                                        <span class="original-price">₹ <span th:text="${#numbers.formatDecimal(p.price, 0, 'COMMA', 2, 'POINT')}">0.00</span></span>
                                        <span class="badge bg-danger discount-badge" th:text="'-' + ${p.discountPercent} + '%'">-10%</span>
                                        <br>
                                        <span class="text-success">₹ <span th:text="${#numbers.formatDecimal(p.getDiscountedPrice(), 0, 'COMMA', 2, 'POINT')}">0.00</span></span>
                                    </span>
                                    <span th:unless="${p.discountPercent > 0}" class="text-success">
                                        ₹ <span th:text="${#numbers.formatDecimal(p.price, 0, 'COMMA', 2, 'POINT')}">0.00</span>
                                    </span>
                                </p>

                                <p class="card-text text-muted small">
                                    Stock: <span th:text="${p.stockQuantity}">0</span>
                                </p>

                                <!-- Actions for Authenticated Users (Cart/Wishlist) - Keep these separate and above the link wrapper z-index -->
                                <div class="mt-2 btn-group" role="group" sec:authorize="isAuthenticated()">
                                    <!-- ADD TO CART -->
                                    <!--<form th:action="@{/cart/add}" method="post" class="d-inline w-50">
                                        <input type="hidden" name="productId" th:value="${p.id}">
                                        <input type="hidden" name="quantity" value="1">
                                        <button type="submit" class="btn btn-brand w-100 btn-sm" th:disabled="${p.stockQuantity == 0}">
                                            <i class="fa fa-shopping-bag me-1"></i> Cart
                                        </button>
                                    </form>-->

                                    <!-- ADD TO WISHLIST -->
                                    <form th:action="@{/wishlist/add/{productId}(productId=${p.id})}" method="post" class="d-inline w-100">
                                        <button type="submit" class="btn btn-outline-danger w-100 btn-sm">
                                            <i class="fa-regular fa-heart"></i> Wishlist
                                        </button>
                                    </form>
                                </div>

                                <!-- REMOVED: View Details button -->
                                <!-- <a th:href="@{'/products/' + ${p.id}}" th:classappend="${#authentication.name} == 'anonymousUser' ? 'w-100' : ''" class="btn btn-dark btn-sm mt-2">View Details</a> -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- END Main Content Wrapper -->

<!-- Include the centralized footer fragment -->
<div th:replace="~{footer.html :: footer}"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // This is necessary to handle the initial state of the price range slider input
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize slider values based on current filter state
        const minPriceRange = document.getElementById('priceRangeMin');
        const maxPriceRange = document.getElementById('priceRangeMax');
        const minPriceDisplay = document.getElementById('priceMinDisplay');
        const maxPriceDisplay = document.getElementById('priceMaxDisplay');
        const filterForm = document.getElementById('filterForm');

        if (minPriceRange && maxPriceRange && filterForm) {

            // Function to update displays and check constraints
            const updatePriceValues = () => {
                const minVal = parseInt(minPriceRange.value);
                const maxVal = parseInt(maxPriceRange.value);

                // Constraint: Ensure min <= max visually
                if (minVal > maxVal) {
                    minPriceRange.value = maxVal;
                }

                // Update text displays with Indian number formatting
                minPriceDisplay.textContent = parseInt(minPriceRange.value).toLocaleString('en-IN');
                maxPriceDisplay.textContent = parseInt(maxPriceRange.value).toLocaleString('en-IN');
            };

            // Event listeners for real-time display update
            minPriceRange.addEventListener('input', updatePriceValues);
            maxPriceRange.addEventListener('input', updatePriceValues);

            // Initial call to set correct starting values if present in model
            updatePriceValues();
        }
    });
</script>
</body>
</html>