<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <title>Saved Addresses - Anvi Studio</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Roboto:wght@300;400&display=swap" rel="stylesheet">
    <style>
        :root{ --brand:#ff7c04; --dark:#222; }
        body { font-family: 'Roboto', sans-serif; background-color: #f7f7f7; display: flex; flex-direction: column; min-height: 100vh; }
        .main-content { flex-grow: 1; }
        .hero-title { font-family: 'Playfair Display', serif; font-weight: 700; color: #000; }
        .address-card { border-radius: 12px; }
        .default-badge { background-color: var(--brand); color: white; }

        /* Ensure Navbar links/colors are consistent */
        .offer-bar{ background: linear-gradient(90deg,#111, #222); color:#fff; padding:6px 0; font-size:0.95rem; }
        .main-nav{ background:#000; color:#fff; }
        .main-nav .nav-link{ color:#fff; }
        .main-nav .nav-link:hover, .main-nav .nav-link.active { color: var(--brand); font-weight: 700; border-bottom: 2px solid var(--brand); padding-bottom: 4px; }
        .navbar-nav { align-items: center; }
        .btn-brand { background-color: var(--brand); border-color: var(--brand); color: white; }
        .btn-brand:hover { background-color: #cc6300; border-color: #cc6300; }

        /* Highlight selected address */
        .address-radio:checked + .address-card {
            border: 2px solid var(--brand);
            box-shadow: 0 4px 15px rgba(255, 124, 4, 0.3);
        }
        /* Style for address card linked to radio button */
        .address-card {
             transition: border-color 0.2s, box-shadow 0.2s;
             cursor: pointer;
        }
    </style>
</head>
<body>

<div th:insert="~{navbar.html :: main-navbar(currentPage='addresses')}"></div>

<div class="main-content container mt-5">
    <h1 class="hero-title display-5 mb-4"><i class="fa fa-map-marker-alt me-2"></i> Select Delivery Address</h1>

    <!-- Breadcrumb showing flow status -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a th:href="@{/cart}">Cart</a></li>
            <li class="breadcrumb-item active">Address</li>
            <li class="breadcrumb-item text-muted">Payment</li>
        </ol>
    </nav>
    <hr>


    <!-- Messages -->
    <div th:if="${successMessage}" class="alert alert-success" role="alert" th:text="${successMessage}"></div>
    <div th:if="${errorMessage}" class="alert alert-danger" role="alert" th:text="${errorMessage}"></div>

    <!-- ERROR MESSAGE FOR UNSELECTED ADDRESS -->
    <div th:if="${paymentError}" class="alert alert-danger" role="alert" th:text="${paymentError}"></div>

    <div class="d-flex justify-content-between align-items-center mb-4">
        <!-- Message for the customer -->
        <h5 class="mb-0 text-muted small">Choose one address below to proceed to payment.</h5>
        <!-- Button for adding a new address -->
        <button type="button" class="btn btn-brand btn-sm" data-bs-toggle="modal" data-bs-target="#addAddressModal">
            <i class="fa fa-plus me-2"></i> Add New Address
        </button>
    </div>

    <!-- MAIN FORM WRAPPING ALL ADDRESSES AND THE CONTINUE BUTTON -->
    <!-- CRITICAL CHANGE: Submit method is GET, and the action targets the payment modes page -->
    <form id="paymentForm" th:action="@{/payment/modes}" method="get">

        <div th:if="${#lists.isEmpty(addresses)}" class="alert alert-info text-center p-4">
            <p class="lead mb-0">No delivery addresses saved yet.</p>
            <p class="mt-2">Add your first address for faster checkout!</p>
            <!-- Hidden input added for required check in JS, though primary validation is handled by 'required' on radio buttons below -->
            <input type="hidden" name="addressId" value="">
        </div>

        <div class="row g-4 mb-5" th:unless="${#lists.isEmpty(addresses)}">
            <div class="col-lg-6" th:each="address : ${addresses}">
                <label class="w-100 d-block">
                    <!-- Radio Button for Address Selection (Hidden for custom styling) -->
                    <input type="radio"
                           name="addressId"
                           th:value="${address.id}"
                           th:checked="${address.isDefault}"
                           class="form-check-input visually-hidden address-radio"
                           required>

                    <!-- Address Card - Uses padding for better click/tap target -->
                    <div class="card address-card shadow-sm p-4 h-100">
                        <div class="d-flex justify-content-between align-items-start">
                            <h5 class="mb-1 fw-bold" th:text="${address.name}">Home</h5>
                            <span th:if="${address.isDefault}" class="badge default-badge">Default</span>
                        </div>
                        <hr class="mt-2 mb-3">
                        <p class="mb-1"><strong>Recipient:</strong> <span th:text="${address.recipientName}"></span></p>
                        <p class="mb-1"><strong>Phone:</strong> <span th:text="${address.phoneNumber}"></span></p>
                        <p class="mb-1 text-muted small" th:text="${address.streetAddress}">123, Main Street</p>
                        <p class="mb-1 text-muted small" th:text="${address.landmark}"></p>
                        <p class="mb-3 text-muted small">
                            <span th:text="${address.city}"></span>, <span th:text="${address.state}"></span> - <span th:text="${address.pincode}"></span>
                        </p>

                        <div class="d-flex justify-content-end gap-2">
                            <!-- Edit Button opens modal for editing the current address -->
                            <button type="button" class="btn btn-outline-secondary btn-sm"
                                    data-bs-toggle="modal" data-bs-target="#addAddressModal"
                                    th:attr="data-address-id=${address.id}, data-address-name=${address.name}, data-address-recipient=${address.recipientName}, data-address-street=${address.streetAddress}, data-address-landmark=${address.landmark}, data-address-city=${address.city}, data-address-state=${address.state}, data-address-pincode=${address.pincode}, data-address-phone=${address.phoneNumber}, data-address-default=${address.isDefault}">
                                <i class="fa fa-edit me-1"></i> Edit
                            </button>
                            <!-- Delete Form -->
                            <form th:action="@{/customer/addresses/delete/{id}(id=${address.id})}" method="post" onsubmit="return confirm('Are you sure you want to delete this address?')">
                                <button type="submit" class="btn btn-outline-danger btn-sm">
                                    <i class="fa fa-trash me-1"></i> Delete
                                </button>
                            </form>
                        </div>
                    </div>
                </label>
            </div>

            <!-- CONTINUE BUTTON -->
            <div class="col-12 text-center mt-5">
                <button type="submit" class="btn btn-brand btn-lg" onclick="return validateAddressSelection()">
                    <i class="fa fa-angle-right me-2"></i> Continue to Payment
                </button>
            </div>
        </div>
    </form>
</div>

<!-- Address Add/Edit Modal -->
<div class="modal fade" id="addAddressModal" tabindex="-1" aria-labelledby="addAddressModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-dark text-white">
                <h5 class="modal-title" id="addAddressModalLabel">Add/Edit Address</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form th:action="@{/customer/addresses/add}" method="post" th:object="${newAddress}" id="addressForm">
                <div class="modal-body">
                    <input type="hidden" id="addressId" name="id" th:value="*{id}">

                    <div class="mb-3">
                        <label for="name" class="form-label">Address Nickname (e.g., Home, Work)</label>
                        <input type="text" id="name" name="name" class="form-control" th:value="*{name}" required>
                    </div>
                    <div class="mb-3">
                        <label for="recipientName" class="form-label">Recipient Name</label>
                        <input type="text" id="recipientName" name="recipientName" class="form-control" th:value="*{recipientName}" required>
                    </div>
                    <div class="mb-3">
                        <label for="phoneNumber" class="form-label">Phone Number</label>
                        <input type="tel" id="phoneNumber" name="phoneNumber" class="form-control" th:value="*{phoneNumber}" required>
                    </div>
                    <div class="mb-3">
                        <label for="streetAddress" class="form-label">Street Address / House No.</label>
                        <input type="text" id="streetAddress" name="streetAddress" class="form-control" th:value="*{streetAddress}" required>
                    </div>
                    <div class="mb-3">
                        <label for="landmark" class="form-label">Landmark (Optional)</label>
                        <input type="text" id="landmark" name="landmark" class="form-control" th:value="*{landmark}">
                    </div>
                    <div class="row g-3">
                        <div class="col-md-6 mb-3">
                            <label for="city" class="form-label">City</label>
                            <input type="text" id="city" name="city" class="form-control" th:value="*{city}" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="state" class="form-label">State</label>
                            <input type="text" id="state" name="state" class="form-control" th:value="*{state}" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="pincode" class="form-label">Pincode</label>
                        <input type="text" id="pincode" name="pincode" class="form-control" th:value="*{pincode}" required>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="isDefault" name="isDefault" th:checked="*{isDefault}">
                        <label class="form-check-label" for="isDefault">Set as Default Address</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-brand">Save Address</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div th:replace="~{footer.html :: footer}"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Script to handle pre-populating the modal for editing an address
    document.addEventListener('DOMContentLoaded', function () {
        const modal = document.getElementById('addAddressModal');
        modal.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget; // Button that triggered the modal
            const id = button ? button.getAttribute('data-address-id') : null;

            const modalTitle = modal.querySelector('.modal-title');
            const addressForm = document.getElementById('addressForm');
            const saveButton = modal.querySelector('.btn-brand');

            // Reset form fields
            addressForm.reset();
            modal.querySelector('#addressId').value = '';
            addressForm.querySelector('input[name="name"]').value = '';
            addressForm.querySelector('input[name="recipientName"]').value = '';
            addressForm.querySelector('input[name="streetAddress"]').value = '';
            addressForm.querySelector('input[name="landmark"]').value = '';
            addressForm.querySelector('input[name="city"]').value = '';
            addressForm.querySelector('input[name="state"]').value = '';
            addressForm.querySelector('input[name="pincode"]').value = '';
            addressForm.querySelector('input[name="phoneNumber"]').value = '';
            addressForm.querySelector('input[name="isDefault"]').checked = false;


            if (id) {
                // Editing existing address
                modalTitle.textContent = 'Edit Address';
                saveButton.textContent = 'Update Address';

                // Populate fields from data attributes
                modal.querySelector('#addressId').value = id;
                addressForm.querySelector('input[name="name"]').value = button.getAttribute('data-address-name');
                addressForm.querySelector('input[name="recipientName"]').value = button.getAttribute('data-address-recipient');
                addressForm.querySelector('input[name="streetAddress"]').value = button.getAttribute('data-address-street');
                addressForm.querySelector('input[name="landmark"]').value = button.getAttribute('data-address-landmark') || '';
                addressForm.querySelector('input[name="city"]').value = button.getAttribute('data-address-city');
                addressForm.querySelector('input[name="state"]').value = button.getAttribute('data-address-state');
                addressForm.querySelector('input[name="pincode"]').value = button.getAttribute('data-address-pincode');
                addressForm.querySelector('input[name="phoneNumber"]').value = button.getAttribute('data-address-phone');
                // Data attributes convert 'true' to string, check if it's the string 'true'
                addressForm.querySelector('input[name="isDefault"]').checked = button.getAttribute('data-address-default') === 'true';

            } else {
                // Adding new address
                modalTitle.textContent = 'Add New Address';
                saveButton.textContent = 'Save Address';
            }
        });

        // Handle address card click to select radio button
        document.querySelectorAll('.address-card').forEach(card => {
            card.addEventListener('click', function(e) {
                // Find the associated radio button and check it
                const input = this.closest('label').querySelector('.address-radio');
                if (input) {
                    input.checked = true;
                }
            });
        });
    });

    // Client-side validation before continuing to payment
    function validateAddressSelection() {
        const radios = document.querySelectorAll('input[name="addressId"]');
        let selected = false;
        radios.forEach(radio => {
            if (radio.checked) {
                selected = true;
            }
        });

        if (!selected) {
            // Note: Replace alert with a custom modal in production!
            alert('Please select a delivery address before proceeding to payment.');
            return false;
        }
        return true;
    }
</script>
</body>
</html>