<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <title th:text="${product.name} + ' | Anvi Studio'"></title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Bootstrap, Fonts, Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Roboto:wght@300;400&display=swap" rel="stylesheet">
    <style>
        :root{ --brand:#ff7c04; --dark:#222; }
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f7f7f7;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        .main-content { flex-grow: 1; }

        /* Navbar/Offer Bar Styles (for consistency with fragment) */
        .offer-bar{ background: linear-gradient(90deg,#111, #222); color:#fff; padding:6px 0; font-size:0.95rem; }
        .main-nav{ background:#000; color:#fff; }
        .main-nav .nav-link{ color:#fff; }
        .main-nav .nav-link:hover, .main-nav .nav-link.active { color: var(--brand); font-weight: 700; border-bottom: 2px solid var(--brand); padding-bottom: 4px; }
        .navbar-nav { align-items: center; }

        .product-main-image { max-height: 550px; object-fit: cover; border-radius: 12px; }
        .btn-brand { background-color: var(--brand); border-color: var(--brand); color: white; }
        .btn-brand:hover { background-color: #cc6300; border-color: #cc6300; }

        /* Price Display Styles for Detail Page */
        .price-display-wrapper { margin-bottom: 15px; }
        .price-display { color: var(--dark); font-size: 2.5rem; font-weight: 700; display: inline-block; }

        /* Discount Styles */
        .original-price {
            text-decoration: line-through;
            color: #888;
            font-size: 0.5em;
            margin-right: 15px;
            display: block;
            font-weight: 400;
        }
        .discount-badge {
            font-size: 0.4em;
            vertical-align: top;
            margin-left: 10px;
            padding: 4px 8px;
        }

        /* NEW: Sale/Clearance Status Text */
        .sale-tag {
            font-size: 1.2rem;
            font-weight: bold;
            display: inline-block;
            margin-left: 15px;
            color: #007bff; /* Sale blue */
        }
        .clearance-tag {
             font-size: 1.2rem;
            font-weight: bold;
            display: inline-block;
            margin-left: 15px;
            color: #dc3545; /* Clearance red */
        }

        .sku-tag { background-color: #eee; padding: 4px 8px; border-radius: 4px; font-size: 0.85rem; }
        .info-tab-link { color: #555; font-weight: 500; transition: color 0.2s; }
        .info-tab-link.active { color: var(--dark); border-bottom: 2px solid var(--brand); }
        .related-product-card img { height: 200px; object-fit: cover; }
        .share-icon { font-size: 1.2rem; transition: color 0.2s; }
        .share-icon:hover { color: var(--brand); }

        /* Footer consistency */
        footer { background-color: var(--dark); color: #fff; margin-top: auto; padding: 15px 0; }
    </style>
</head>
<body>

<!-- INCLUDE REUSABLE NAVBAR FRAGMENT -->
<div th:insert="~{navbar.html :: main-navbar(currentPage='shop')}"></div>

<!-- MAIN CONTENT WRAPPER -->
<div class="main-content container my-5">

    <!-- Breadcrumb (Simple) -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/">Home</a></li>
            <li class="breadcrumb-item"><a th:href="@{/products}">Shop</a></li>
            <li class="breadcrumb-item active" aria-current="page" th:text="${product.name}">Product Detail</li>
        </ol>
    </nav>

    <!-- PRODUCT DETAIL SECTION -->
    <div class="row g-5">

        <!-- Left Column: Image and Gallery -->
        <div class="col-lg-6">
            <img th:src="${product.imageUrl}"
                 onerror="this.onerror=null; this.src='https://placehold.co/600x550/ccc/333?text=Image+Missing';"
                 class="img-fluid w-100 product-main-image shadow-lg"
                 alt="Main Product Image">

            <!-- Future: Image Gallery thumbnails could go here -->
        </div>

        <!-- Right Column: Details and Actions -->
        <div class="col-lg-6">
            <h1 class="display-6 fw-bold" th:text="${product.name}">Product Name</h1>

            <!-- Price Display Wrapper (Updated for Discount & Sale Status) -->
            <div class="price-display-wrapper">
                <span th:if="${product.discountPercent > 0}">
                    <!-- Original Price (Strike-through) -->
                    <span class="original-price">
                         MRP: ₹ <span th:text="${#numbers.formatDecimal(product.price, 0, 'COMMA', 2, 'POINT')}">0.00</span>
                    </span>
                    <!-- Discounted Price -->
                    <span class="price-display text-success">
                         ₹ <span th:text="${#numbers.formatDecimal(product.getDiscountedPrice(), 0, 'COMMA', 2, 'POINT')}">0.00</span>
                    </span>
                    <!-- Discount Badge -->
                    <span class="badge bg-danger discount-badge" th:text="${product.discountPercent} + '% OFF'">10% OFF</span>

                    <!-- NEW: Sale/Clearance Tag -->
                    <span th:if="${product.isClearance()}" class="clearance-tag">
                        <i class="fa fa-fire me-1"></i> CLEARANCE SALE!
                    </span>
                    <span th:unless="${product.isClearance()}" class="sale-tag">
                        <i class="fa fa-tag me-1"></i> ON SALE
                    </span>
                </span>

                <span th:unless="${product.discountPercent > 0}">
                    <!-- Regular Price -->
                    <span class="price-display">
                         ₹ <span th:text="${#numbers.formatDecimal(product.price, 0, 'COMMA', 2, 'POINT')}">0.00</span>
                    </span>
                </span>
            </div>

            <p class="mb-1">
                <span class="sku-tag me-2" th:text="'SKU: ' + ${product.sku}">SKU</span>
                <span th:if="${product.stockQuantity > 0}" class="badge bg-success">In Stock: <span th:text="${product.stockQuantity}"></span></span>
                <span th:unless="${product.stockQuantity > 0}" class="badge bg-danger">Out of Stock</span>
            </p>

            <!-- Short Description -->
            <p class="text-muted mt-3" th:text="${product.description}"></p>

            <hr>

            <!-- SIZE OPTIONS AND QUANTITY -->
            <form th:action="@{/cart/add}" method="post" class="mt-4">
                <input type="hidden" name="productId" th:value="${product.id}">

                <div th:if="${product.sizeOptions != null and product.sizeOptions.trim().length() > 0}">
                    <label for="sizeSelect" class="form-label fw-bold">Size:</label>
                    <div class="d-flex align-items-center mb-3">
                        <select id="sizeSelect" name="size" class="form-select w-50 me-3" required>
                            <option value="" disabled selected>Choose Size</option>
                            <!-- Split size options by comma and iterate -->
                            <option th:each="size : ${product.sizeOptions.split(',')}"
                                    th:value="${size.trim()}"
                                    th:text="${size.trim()}">M</option>
                        </select>
                        <a th:if="${product.sizeGuideUrl != null and product.sizeGuideUrl.trim().length() > 0}"
                           th:href="${product.sizeGuideUrl}" target="_blank" class="small text-decoration-none">
                            <i class="fa fa-ruler-horizontal me-1"></i> Size Guide
                        </a>
                    </div>
                </div>

                <!-- Quantity and Add to Cart -->
                <div class="d-flex align-items-center mb-4">
                    <input type="number" name="quantity" value="1" min="1" th:max="${product.stockQuantity}" class="form-control w-25 me-3" th:disabled="${product.stockQuantity == 0}">
                    <button type="submit" class="btn btn-brand btn-lg flex-grow-1" th:disabled="${product.stockQuantity == 0}">
                        <i class="fa fa-shopping-bag me-2"></i> Add to Cart
                    </button>
                    <!-- Wishlist Button -->
                    <form th:action="@{/wishlist/add/{productId}(productId=${product.id})}" method="post" class="d-inline ms-2">
                        <button type="submit" class="btn btn-outline-danger btn-lg" title="Add to Wishlist">
                            <i class="fa-regular fa-heart"></i>
                        </button>
                    </form>
                </div>
            </form>

            <!-- DELIVERY AND SHARING INFO -->
            <div class="mt-4 p-3 bg-light rounded">
                <p class="mb-2 small">
                    <i class="fa fa-truck me-2 text-muted"></i> Estimated Delivery:
                    <span class="fw-bold" th:text="${product.estimatedDelivery ?: 'Details provided at checkout.'}">4-6 Business Days</span>
                </p>
                <p class="mb-2 small">
                    <i class="fa fa-exchange-alt me-2 text-muted"></i> Returns:
                    <span th:text="${product.deliveryAndReturnPolicy ?: 'Standard 7-day exchange policy applies.'}">Standard policy</span>
                </p>
                <p class="mb-0 small text-muted">
                    <i class="fa fa-share-alt me-2"></i> Share:
                    <a href="javascript:void(0)" onclick="copyProductLink()" class="share-icon mx-1"><i class="fab fa-whatsapp"></i></a>
                    <a href="javascript:void(0)" class="share-icon mx-1"><i class="fab fa-facebook"></i></a>
                    <a href="javascript:void(0)" class="share-icon mx-1"><i class="fa fa-copy"></i></a>
                </p>
            </div>
        </div>
    </div>

    <!-- TABS SECTION: Description, Additional Info, Reviews -->
    <div class="mt-5 pt-4">
        <ul class="nav nav-tabs" id="productTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link info-tab-link active" id="desc-tab" data-bs-toggle="tab" data-bs-target="#desc" type="button" role="tab">Description</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link info-tab-link" id="add-info-tab" data-bs-toggle="tab" data-bs-target="#add-info" type="button" role="tab">Additional Information</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link info-tab-link" id="reviews-tab" data-bs-toggle="tab" data-bs-target="#reviews" type="button" role="tab">Reviews (0)</button>
            </li>
        </ul>

        <div class="tab-content border-start border-end border-bottom bg-white p-4 shadow-sm">

            <!-- Description Tab Content -->
            <div class="tab-pane fade show active" id="desc" role="tabpanel" aria-labelledby="desc-tab">
                <h5 th:text="${product.name}">Product Description</h5>
                <!-- Full product description (using basic markdown-style line breaks for readability) -->
                <p th:utext="${#strings.replace(product.description, '\n', '<br>')}" class="text-muted">Detailed description goes here.</p>

                <h6 class="mt-4">Category Tags</h6>
                <div th:if="${product.productTags != null}">
                    <span th:each="tag : ${product.productTags.split(',')}" class="badge bg-secondary me-2" th:text="${tag.trim()}">tag</span>
                </div>
                <div th:unless="${product.productTags != null}">
                    <span class="text-muted small">No specific tags defined.</span>
                </div>
            </div>

            <!-- Additional Information Tab Content -->
            <div class="tab-pane fade" id="add-info" role="tabpanel" aria-labelledby="add-info-tab">
                <!-- Additional Information (Fabric Details, Wash Care) -->
                <h6 class="mb-3">Fabric & Care Details</h6>
                <p th:utext="${#strings.replace(product.additionalInformation ?: 'No additional details provided by Admin.', '\n', '<br>')}" class="text-muted"></p>

                <!-- SKU, Category -->
                <div class="mt-4">
                    <p class="mb-1"><strong>Category:</strong> <span th:text="${product.category}"></span></p>
                    <p class="mb-1"><strong>SKU/Model:</strong> <span th:text="${product.sku ?: 'N/A'}"></span></p>
                    <p class="mb-1"><strong>Available Sizes:</strong> <span th:text="${product.sizeOptions ?: 'N/A'}"></span></p>
                    <p class="mb-1"><strong>Discount Applied:</strong> <span th:text="${product.discountPercent} + '%'">0%</span></p>
                </div>
            </div>

            <!-- Reviews Tab Content -->
            <div class="tab-pane fade" id="reviews" role="tabpanel" aria-labelledby="reviews-tab">
                <p class="text-center text-muted">Be the first to review this product!</p>
                <!-- Future: Review submission form and review list goes here -->
            </div>
        </div>
    </div>

    <!-- RELATED PRODUCTS SECTION -->
    <section class="mt-5 pt-5">
        <h3 class="fw-bold mb-4">Related Products</h3>

        <div th:if="${#lists.isEmpty(relatedProducts)}" class="alert alert-info text-center">
            No related products found in the same category.
        </div>

        <div class="row g-4" th:unless="${#lists.isEmpty(relatedProducts)}">
            <div class="col-sm-6 col-md-4 col-lg-3" th:each="relatedP : ${relatedProducts}">
                <a th:href="@{'/products/' + ${relatedP.id}}" class="card shadow-sm h-100 text-decoration-none text-dark related-product-card">

                    <!-- NEW: SALE/CLEARANCE BADGE on related product -->
                    <span th:if="${relatedP.isClearance()}" class="sale-status-badge clearance-badge">CLEARANCE!</span>
                    <span th:unless="${relatedP.isClearance() or relatedP.discountPercent == 0}" class="sale-status-badge sale-badge">SALE</span>

                    <img th:src="${relatedP.imageUrl}"
                         onerror="this.onerror=null; this.src='https://placehold.co/400x200/ccc/333?text=Related';"
                         class="card-img-top"
                         alt="Related Product Image">
                    <div class="card-body">
                        <h6 class="card-title mb-1" th:text="${relatedP.name}">Related Name</h6>

                        <!-- Related Product Price Display (with discount) -->
                        <p class="card-text fw-bold">
                            <span th:if="${relatedP.discountPercent > 0}" class="text-secondary d-block">
                                <span class="original-price" style="font-size: 0.75em;">₹ <span th:text="${#numbers.formatDecimal(relatedP.price, 0, 'COMMA', 2, 'POINT')}">0.00</span></span>
                                <br>
                                <span class="text-success">₹ <span th:text="${#numbers.formatDecimal(relatedP.getDiscountedPrice(), 0, 'COMMA', 2, 'POINT')}">0.00</span></span>
                            </span>
                            <span th:unless="${relatedP.discountPercent > 0}" class="text-success">
                                ₹ <span th:text="${#numbers.formatDecimal(relatedP.price, 0, 'COMMA', 2, 'POINT')}">0.00</span>
                            </span>
                        </p>
                    </div>
                </a>
            </div>
        </div>
    </section>

</div>
<!-- END MAIN CONTENT WRAPPER -->


<!-- Include the centralized footer fragment -->
<div th:replace="~{footer.html :: footer}"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Function to copy the current product URL to the clipboard
    function copyProductLink() {
        const url = window.location.href;

        // This is a browser feature, but may not work in all limited environments (like some sandbox iframes)
        if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(url).then(() => {
                // IMPORTANT: Replace alert() with a custom modal/message box in a final app
                alert("Product link copied to clipboard!");
            }).catch(err => {
                fallbackCopyTextToClipboard(url);
            });
        } else {
            // Fallback for older browsers or restricted environments
            fallbackCopyTextToClipboard(url);
        }
    }

    // Fallback for copying text (using document.execCommand)
    function fallbackCopyTextToClipboard(text) {
        const textArea = document.createElement("textarea");
        textArea.value = text;
        textArea.style.position = "fixed"; // Avoid scrolling to bottom
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        try {
            const successful = document.execCommand('copy');
            // IMPORTANT: Replace alert() with a custom modal/message box in a final app
            const msg = successful ? 'Product link copied!' : 'Failed to copy text.';
            alert(msg);
        } catch (err) {
            console.error('Fallback: Oops, unable to copy', err);
        }
        document.body.removeChild(textArea);
    }
</script>
</body>
</html>
